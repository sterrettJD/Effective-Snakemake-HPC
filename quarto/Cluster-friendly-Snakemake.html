<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Effective Snakemake on Computer Clusters - Cluster-friendly Snakemake</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Effective Snakemake on Computer Clusters</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../quarto/About-Snakemake.html" rel="" target="">
 <span class="menu-text">About Snakemake</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../quarto/Snakemake-Essentials.html" rel="" target="">
 <span class="menu-text">Snakemake Essentials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../quarto/Qiime2-Applications.html" rel="" target="">
 <span class="menu-text">Qiime2 Applications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../quarto/Cluster-friendly-Snakemake.html" rel="" target="" aria-current="page">
 <span class="menu-text">Cluster-friendly Snakemake</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#using-a-compute-cluster" id="toc-using-a-compute-cluster" class="nav-link active" data-scroll-target="#using-a-compute-cluster">Using a compute cluster</a>
  <ul class="collapse">
  <li><a href="#shared-resource" id="toc-shared-resource" class="nav-link" data-scroll-target="#shared-resource">Shared resource</a></li>
  <li><a href="#slurm" id="toc-slurm" class="nav-link" data-scroll-target="#slurm">SLURM</a></li>
  <li><a href="#batch-jobs" id="toc-batch-jobs" class="nav-link" data-scroll-target="#batch-jobs">Batch jobs</a></li>
  <li><a href="#example-batch-jobs-submission" id="toc-example-batch-jobs-submission" class="nav-link" data-scroll-target="#example-batch-jobs-submission">Example batch jobs submission</a></li>
  <li><a href="#using-snakemake-to-automate-batch-job-submission" id="toc-using-snakemake-to-automate-batch-job-submission" class="nav-link" data-scroll-target="#using-snakemake-to-automate-batch-job-submission">Using Snakemake to automate batch job submission</a>
  <ul class="collapse">
  <li><a href="#story-time" id="toc-story-time" class="nav-link" data-scroll-target="#story-time">Story time</a></li>
  <li><a href="#snakemake-slurm" id="toc-snakemake-slurm" class="nav-link" data-scroll-target="#snakemake-slurm">Snakemake + Slurm</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#setting-up-a-slurm-profile" id="toc-setting-up-a-slurm-profile" class="nav-link" data-scroll-target="#setting-up-a-slurm-profile">Setting up a SLURM profile</a>
  <ul class="collapse">
  <li><a href="#why-it-matters" id="toc-why-it-matters" class="nav-link" data-scroll-target="#why-it-matters">Why it matters</a></li>
  <li><a href="#using-cookiecutter" id="toc-using-cookiecutter" class="nav-link" data-scroll-target="#using-cookiecutter">Using cookiecutter</a>
  <ul class="collapse">
  <li><a href="#about-the-profile" id="toc-about-the-profile" class="nav-link" data-scroll-target="#about-the-profile">About the profile</a></li>
  <li><a href="#installating-cookiecutter" id="toc-installating-cookiecutter" class="nav-link" data-scroll-target="#installating-cookiecutter">Installating cookiecutter</a></li>
  <li><a href="#snakemake-slurm-profile-setup" id="toc-snakemake-slurm-profile-setup" class="nav-link" data-scroll-target="#snakemake-slurm-profile-setup">Snakemake SLURM profile setup</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#submitting-slurm-jobs-with-snakemake" id="toc-submitting-slurm-jobs-with-snakemake" class="nav-link" data-scroll-target="#submitting-slurm-jobs-with-snakemake">Submitting Slurm jobs with Snakemake</a>
  <ul class="collapse">
  <li><a href="#tell-snakemake-about-your-profile" id="toc-tell-snakemake-about-your-profile" class="nav-link" data-scroll-target="#tell-snakemake-about-your-profile">Tell Snakemake about your profile</a></li>
  <li><a href="#providing-resources-in-rules" id="toc-providing-resources-in-rules" class="nav-link" data-scroll-target="#providing-resources-in-rules">Providing resources in rules</a></li>
  <li><a href="#rules-from-a-config-file" id="toc-rules-from-a-config-file" class="nav-link" data-scroll-target="#rules-from-a-config-file">Rules from a config file</a>
  <ul class="collapse">
  <li><a href="#passing-a-config-file-to-snakemake" id="toc-passing-a-config-file-to-snakemake" class="nav-link" data-scroll-target="#passing-a-config-file-to-snakemake">Passing a config file to Snakemake</a></li>
  <li><a href="#using-a-config-for-resources" id="toc-using-a-config-for-resources" class="nav-link" data-scroll-target="#using-a-config-for-resources">Using a config for resources</a></li>
  <li><a href="#sanitizing-config-resources" id="toc-sanitizing-config-resources" class="nav-link" data-scroll-target="#sanitizing-config-resources">Sanitizing config resources</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Cluster-friendly Snakemake</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="using-a-compute-cluster" class="level1">
<h1>Using a compute cluster</h1>
<section id="shared-resource" class="level2">
<h2 class="anchored" data-anchor-id="shared-resource">Shared resource</h2>
<p>Compute clusters are often shared resources. For example, <a href="https://bit.colorado.edu/biofrontiers-computing/fiji/">Fiji</a> and <a href="https://www.colorado.edu/rc/alpine">Alpine</a> are two high performance compute clusters for researchers at the University of Colorado. These resources are shared across the entire university (and sometimes multiple universities), which makes managing resources very important.</p>
</section>
<section id="slurm" class="level2">
<h2 class="anchored" data-anchor-id="slurm">SLURM</h2>
<p>Resource management for computing is often done using a job scheduler such as <a href="https://slurm.schedmd.com/overview.html">Slurm</a>. Slurm will be the focal job scheduling system in this resource, but others exist (the concepts remain consistent across other systems). Slurm manages the priority of compute jobs across users (based on factors such as memory/time requirements and user priority), and it manages parallelization and execution of jobs on compute nodes.</p>
</section>
<section id="batch-jobs" class="level2">
<h2 class="anchored" data-anchor-id="batch-jobs">Batch jobs</h2>
<p>Unlike running commands from a command line on your local computer, any compute-heavy jobs on clusters need to be done through the submission of batch jobs. Batch jobs could be considered “wrappers” for your compute jobs, with specifications of the resources needed. Slurm allocates the necessary resources on a compute node, then sends that job to be performed on the compute node. Below is an image from ETH Zurich scientific computing <a href="https://scicomp.ethz.ch/wiki/Job_management_with_SLURM">wiki</a> demonstrating this process. <img src="../figures/1000px-Batch_system.png" class="img-fluid" alt="Figure of batch job submission"></p>
</section>
<section id="example-batch-jobs-submission" class="level2">
<h2 class="anchored" data-anchor-id="example-batch-jobs-submission">Example batch jobs submission</h2>
<p>This often involved running a <code>.sbatch</code> script, which has the resource requirements at the top. Here is an example for trimming reads in a fastq file:</p>
<pre class="{snakemake}"><code>#SBATCH --mail-user=&lt;email_address&gt;@colorado.edu
#SBATCH --partition=short # run on the short partition
#SBATCH --nodes=1 # Only use a single node
#SBATCH --ntasks=1 # Run with one thread
#SBATCH --mem=8gb # Memory limit
#SBATCH --time=02:00:00 # Time limit hrs:min:sec
#SBATCH --output=/path/to/here/logs/trim_reads_%j.out # Standard output and error log
#SBATCH --error=/path/to/here/logs/trim_reads_%j.err # %j inserts job number

# activate conda environment
source activate seqtk_env

# trim reads
seqtk trimfq -b 10 -e 5 raw_reads.fq &gt; trimmed_reads.fq</code></pre>
<p>Which could be run with the following command:</p>
<pre><code>sbatch trim_reads.sbatch</code></pre>
</section>
<section id="using-snakemake-to-automate-batch-job-submission" class="level2">
<h2 class="anchored" data-anchor-id="using-snakemake-to-automate-batch-job-submission">Using Snakemake to automate batch job submission</h2>
<p>This works well for single jobs, but again, when things start to scale up (50 samples, 10 steps per sample, etc..), this can become cumbersome.</p>
<section id="story-time" class="level3">
<h3 class="anchored" data-anchor-id="story-time">Story time</h3>
<p>When I was new to working on clusters, I found myself writing python scripts to loop through each of my samples, find their files, then run sbatch scripts that had to parse/sanitize multiple parameters. I certainly could have done this more simply, but it quickly snowballed into a 50-150 line python script with a &gt;25 line sbatch script per step, leading to a &gt;&gt;1000 line codebase for a project with just a few processing steps. The last straw was when I needed to go back and run step 1 with new parameters, meaning I had to manually rerun every following step (after waiting for all samples to finish each step).</p>
<p>Using Snakemake, to manage I was able to reduce this codebase by ~70% and reduce my manual input by ~50%. To quote Casey Martin, “Compute flops are cheap and nearly unlimited at our level; human flops are expensive and limited,” so we need to prioritize efficiency in our human flops, using tools like Snakemake.</p>
</section>
<section id="snakemake-slurm" class="level3">
<h3 class="anchored" data-anchor-id="snakemake-slurm">Snakemake + Slurm</h3>
<p>My favorite part of using Snakemake has been that once a Slurm profile is set up, it will handle all of the <code>sbatch</code> job submission for you. This “profile” is really just a little tool that creates the <code>.sbatch</code> script, submits it, logs output/error, and monitors completion. In your Snakefile, you can specify resource requirements and conda environment, such that the previous script would look like this:</p>
<pre class="{snakemake}"><code>rule trim_fastq:
    input:
        "raw_reads.fq"
    output:
        "trimmed_reads.fq"
    resources:
        partition="short",
        mem_mb=8000,
        runtime=120 #min
    threads: 1
    conda: "seqtk_env"
    shell:
        """
        seqtk trimfq -b 10 -e 5 {input} &gt; {output}
        """</code></pre>
<p>In this case it doesn’t look much more concise, but it is much easier to generalize this rule to run multiple samples/parameters, and to chain multiple samples together. Most importantly, it’s easier to read and debug!</p>
<blockquote class="blockquote">
<p>“Programs must be written for people to read, and only incidentally for machines to execute.” ― Harold Abelson, Structure and Interpretation of Computer Programs</p>
</blockquote>
</section>
</section>
</section>
<section id="setting-up-a-slurm-profile" class="level1">
<h1>Setting up a SLURM profile</h1>
<p>This section will explain how to set up a profile to integrate Snakemake with the job scheduling system, Slurm.</p>
<section id="why-it-matters" class="level2">
<h2 class="anchored" data-anchor-id="why-it-matters">Why it matters</h2>
<p>Slurm profiles are advantageous because they manage submission/monitoring of each step in your Snakemake pipeline as separate batch jobs. For example, if you have 50 samples to process through 10 rules, the SLURM profile will submit/monitor each rule &amp; sample combination as a separate job, so:</p>
<ol type="1">
<li>These jobs can run in parallel, with unique resource requirements for each job.</li>
<li>It is easy to monitor the job status for each unique sample/step.</li>
<li>If one fails, the others will keep going.</li>
</ol>
<p>Without a Slurm profile, Snakemake would try to run each job sequentially within the batch job that you’ve submitted to run Snakemake, and this could get cumbersome. Additionally, imagine step 1 requires 2 GB of memory, but step 2 requires 100 GB memory. Without submitting individual batch jobs for each step/sample, you would have to request 100 GB memory for the full duration, which would result in a waste of resources on the shared cluster while the first step is running.</p>
</section>
<section id="using-cookiecutter" class="level2">
<h2 class="anchored" data-anchor-id="using-cookiecutter">Using cookiecutter</h2>
<section id="about-the-profile" class="level3">
<h3 class="anchored" data-anchor-id="about-the-profile">About the profile</h3>
<p>I recommend using the <a href="https://github.com/Snakemake-Profiles/slurm">official Snakemake Slurm profile</a>, which you can install using <a href="https://cookiecutter.readthedocs.io/en/stable/README.html">cookiecutter</a>. This profile manages job submission and monitors submitted jobs.</p>
<p>If you plan on running a Snakemake pipeline with <strong>many many</strong> steps that do not take very long to run (i.e., you’re submitting tens of thousands of jobs that run quickly, such that the submission is the bottleneck), you may want to check out John Blischak’s <a href="https://github.com/jdblischak/smk-simple-slurm">simple Snakemake Slurm profile</a>, which is does not have as many status checks and submits jobs much faster. If job submission isn’t a bottleneck, it’s best to use the official Snakemake SLURM profile (<a href="https://github.com/jdblischak/smk-simple-slurm#use-speed-with-caution">use speed with caution</a>).</p>
</section>
<section id="installating-cookiecutter" class="level3">
<h3 class="anchored" data-anchor-id="installating-cookiecutter">Installating cookiecutter</h3>
<p>In your Snakemake Conda environment:</p>
<pre><code>pip install pipx
pipx install cookiecutter</code></pre>
</section>
<section id="snakemake-slurm-profile-setup" class="level3">
<h3 class="anchored" data-anchor-id="snakemake-slurm-profile-setup">Snakemake SLURM profile setup</h3>
<p>In your Snakemake Conda environment:</p>
<pre><code># create config directory that snakemake searches for profiles (or use something else)
profile_dir="${HOME}/.config/snakemake"
mkdir -p "$profile_dir"
# use cookiecutter to create the profile in the config directory
template="gh:Snakemake-Profiles/slurm"
cookiecutter --output-dir "$profile_dir" "$template"</code></pre>
<p>Then, hit enter to follow all of the default prompts, <strong>except</strong> make sure <code>use_conda</code> is <code>True</code>. That will look like this: <img src="../figures/profile-setup.png" class="img-fluid" alt="screenshot of profile setup"></p>
</section>
</section>
</section>
<section id="submitting-slurm-jobs-with-snakemake" class="level1">
<h1>Submitting Slurm jobs with Snakemake</h1>
<section id="tell-snakemake-about-your-profile" class="level2">
<h2 class="anchored" data-anchor-id="tell-snakemake-about-your-profile">Tell Snakemake about your profile</h2>
<p>When running Snakemake with a profile, you need to use the <code>--profile</code> flag, like this:</p>
<pre><code>snakemake --profile ~/.config/snakemake/slurm</code></pre>
</section>
<section id="providing-resources-in-rules" class="level2">
<h2 class="anchored" data-anchor-id="providing-resources-in-rules">Providing resources in rules</h2>
<p>In your rule, you can pass resources much like passing input/outputs specs. Threads are generally passed outside of the <code>resources</code> section. Additionally, any specifications for a rule can be accessed in the rule’s shell command, using syntax such as <code>{resources.partition}</code> to access the partition name, or <code>{threads}</code> to access the number of threads. Typically, you shouldn’t need to access Slurm-specific aspects like the partition (your profile is handling this), but for some command line tools, where you can specifiy resources, it’s useful to pass <code>{threads}</code> into your shell command.</p>
<p>You can consult the profile’s documentation for all of the options, but this is how I pass my resources.</p>
<pre class="{snakemake}"><code>rule parallelizable_job:
    input:
        "raw_reads.fq"
    output:
        "trimmed_reads.fq"
    resources:
        partition="&lt;partition_name&gt;",
        mem_mb=int(8*1000), # 8 GB
        runtime=int(2*60), # min, or 2 hours
        slurm="mail-user=&lt;email_address&gt;@colorado.edu"
    threads: 8
    shell:
        """
        run_parallelizable_task --threads {threads} --max_memory {resources.mem_mb}
        """</code></pre>
<p>Additionally, you can generally pass any “long format” names for <a href="https://slurm.schedmd.com/sbatch.html">Slurm parameters</a> in your <code>resources.slurm</code> string. More details on that formatting can be found <a href="https://github.com/Snakemake-Profiles/slurm#rule-specific-resource-configuration">here</a>.</p>
</section>
<section id="rules-from-a-config-file" class="level2">
<h2 class="anchored" data-anchor-id="rules-from-a-config-file">Rules from a config file</h2>
<section id="passing-a-config-file-to-snakemake" class="level3">
<h3 class="anchored" data-anchor-id="passing-a-config-file-to-snakemake">Passing a config file to Snakemake</h3>
<p>It’s recommended to provide rule-specific resources in a config file. Config files for Snakemake are <code>.yaml</code> format, and they should be specified when running Snakemake from the command line, as such:</p>
<pre><code>snakemake --profile ~/.config/snakemake/slurm --config Snakemake_config.yaml</code></pre>
</section>
<section id="using-a-config-for-resources" class="level3">
<h3 class="anchored" data-anchor-id="using-a-config-for-resources">Using a config for resources</h3>
<p>Once a config file has been provided to Snakemake, it will recognize the variable <code>config</code> in your snakefile, which is a Python <a href="https://docs.python.org/3/tutorial/datastructures.html#dictionaries">dictionary</a>.</p>
<p>If your config file looks like this:</p>
<pre><code>parallelizable_job_threads: 8
parallelizable_job_mem_mb: 8000</code></pre>
<p>Your Snakemake rule can be written as such:</p>
<pre class="{snakemake}"><code>rule parallelizable_job:
    input:
        "raw_reads.fq"
    output:
        "trimmed_reads.fq"
    resources:
        partition="&lt;partition_name&gt;",
        mem_mb=config.get("parallelizable_job_mem_mb"), # 8 GB
        runtime=int(2*60), # min, or 2 hours
        slurm="mail-user=&lt;email_address&gt;@colorado.edu"
    threads: config.get("parallelizable_job_threads")
    shell:
        """
        run_parallelizable_task --threads {threads} --max_memory {resources.mem_mb}
        """</code></pre>
</section>
<section id="sanitizing-config-resources" class="level3">
<h3 class="anchored" data-anchor-id="sanitizing-config-resources">Sanitizing config resources</h3>
<p>I personally like to set default resources for each rule in my Snakefile and sanitize the config resources. I’m not sure if it’s “best practices”, but it feels safer. For example, if I accidentally delete the memory param from my config, I don’t want the Snakemake to instead pass the default memory param to Slurm.</p>
<section id="story-time---dont-forget-the-resource-requirements" class="level4">
<h4 class="anchored" data-anchor-id="story-time---dont-forget-the-resource-requirements">Story time - don’t forget the resource requirements!!</h4>
<p>I once left out some important resource requirements, leading to crashing two nodes of a compute cluster. When reconstructing genomes from metagenomes (MAGs) using MetaSPAdes (which needed ~150GB per sample), I accidentally deleted the memory requirement in my config file, and Snakemake submitted 50 jobs to Slurm, requesting the default of 8GB per sample. Slurm scheduled all of these jobs on two compute nodes with 500GB total RAM, thinking I needed ~400GB total, when I really needed ~7500GB, and I crashed these compute nodes and received a scary email from the cluster admins. Learn from my mistakes!</p>
</section>
<section id="how-i-avoid-issues" class="level4">
<h4 class="anchored" data-anchor-id="how-i-avoid-issues">How I avoid issues</h4>
<p>I write functions such as this one to handle the resources I’m passing to each rule:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_threads(rule_default, config, rule_name):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    config_param <span class="op">=</span> config.get(<span class="ss">f"</span><span class="sc">{</span>rule_name<span class="sc">}</span><span class="ss">_threads"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> config_param <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">int</span>(config_param)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rule_default</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And my rule would look like this:</p>
<pre><code>rule my_rule:
    output:
        "out_file.txt"
    threads: get_threads(rule_default=1, config, "my_rule")
    shell:
        """
        do things...
        """</code></pre>
<p>This function looks for rule-specific threads in the config, formatted as “<rule_name>_threads”. If that exists, it will use the rule-specific threads from the config, but if not, we already have a default rule-specific number of threads specified. I like this structure because it keeps my config file concise while still maintaining the ability to alter rules’ resources.</rule_name></p>
<p>If you have a better way to do this, feel free to open an issue/pull request, and I can add it!</p>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>